---
title: "Initial Analysis"
author: "Juliano Palacios-Abrantes"
date: '2019-02-04'
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, eval = T, echo=F, warning=F,message=F, results='hide'}

#### READ ME !!! ####
# Run this chunk before knit so you make sure you have all pkgs installed in R

ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE,repos = "http://cran.us.r-project.org")
  sapply(pkg, require, character.only = TRUE)
}


#### Library ####
packages <- c(
  "readxl", # Read dataframe
  "data.table", # Read dataframe (Fast!)
  "dplyr", # Data manipulation
  "tidyr", # Data manipulation
  "ggplot2", #Nice grpahs and spatial analysis
  # "cowplot",
  # "rgdal",
  # "RColorBrewer",
  # "knitr",
  # "kableExtra",
  # "ggrepel",
  # "gridExtra",
  # "ggmap",
  # "rgeos",
  # "stringr",
  # "stringer",
  "spdep", # for poly2nb
  "sf", #Spatial analysis 
  "sp", #Spatial analysis 
  "purrr",#Spatial analysis
  "rgdal", #Spatial analysis
  "tools", #Spatial analysis 
  # "png", # For reading plots in chunk codes
  # "grid" # For reading plots in chunk codes
  "parallel" # for parallelization
)

ipak(packages)


```


# Methods

These are the methods to follow:

1. Determine which countries have neighboring EEZs  
  1.1. For this we used the Marine regions EEZ maps (We have to change this because it does not discriminate by oceans and we need this) and a routine to identify neighboring polygons,
  1.2. Then we match the DBEM spatial information (e.g. INDEX within EEZ and coordinates) with the neighboring data
2. Overlap distribution maps with neighbors data  
  2.1. For each species we merged the DBEM_Neighbors data with their known distribution (Gab's data)  
3. Determine transboundary if:  
  3.1. Species is present in both neighboring EEZs by INDEX  

Alternatively, we could create a "confidence level" based on a ratio, i.e;
- How many grid cells of both the EEZs is the species present on. A species that covers all cells would have 100% but a species that covers, lets say, all of EEZ1 but only half of EEZ2 would be 75%.  
- Another option is to have the index based on the species distribution. That is to say, what proportion of the total species distribution actually falls within both EEZs....


### Current issues

- How to distinguish between North and South? Example of Brazil, Uruguay and French Guyana

## Data

```{r Speceis_Models, eval = F, echo = T}

# Get the DBEM list of species to extract from other modesl
#GFDL
DBEM_species_G <- data_frame(TaxonKey = list.files("/Volumes/DATA/DATA/DBEM/GFDL26F1"))
#IPSL
DBEM_species_I <- data_frame(TaxonKey = list.files("/Volumes/DATA/DATA/DBEM/IPSL26F1"))
#MPI
DBEM_species_M <- data_frame(TaxonKey = list.files("/Volumes/DATA/DATA/DBEM/MPI26F1"))


# Merge the, and save to send to gabs

DBEM_Species_List <- DBEM_species_I %>% 
  bind_rows(DBEM_species_G,
            DBEM_species_M) %>% 
  group_by(TaxonKey) %>% 
  summarise() %>% 
  filter(str_detect(TaxonKey, "^6"))


# Include species name, as well... 

exploited_species <- read.csv("/Volumes/DATA/PROJECTION exploited species ENM/exploited_species_list.csv")

DBEM_Species_List <- DBEM_Species_List %>% 
  left_join(exploited_species,
            by ="TaxonKey")


# write.csv(DBEM_Species_List,
#           "DBEM_Species_List.csv",
#           row.names = F)

### Check Gabs Data ####

# Does all data have the same number of files?

# SAU <- length(list.files("/Volumes/DATA/JULIANO_NEYMAR/FishForVisa/Distribution_Data/SAU_Distribution/"))
# ENM <- length(list.files("/Volumes/DATA/JULIANO_NEYMAR/FishForVisa/Distribution_Data/ENM/"))
# Occ <- length(list.files("/Volumes/DATA/JULIANO_NEYMAR/FishForVisa/Distribution_Data/Occurence/"))

####### Yes they do! ####

#### List of species we have data for...

# Removes everything before the number
Step_One <- gsub(".*_","",list.files("/Volumes/DATA/JULIANO_NEYMAR/FishForVisa/Distribution_Data/SAU_Distribution/"))

# Species List
Species_List <- gsub("\\..*","",Step_One)


```



```{r Spatial_Data, eval = T, echo = T, results='hide'}


# Spatial analysis for Countries boundaries from marine regions ####

###_______________________________Read Me_____________________________________________#
#### Data License and references ###
# Marine Regionsâ€™ data is licensed under CC-By-NC-SA (https://creativecommons.org/licenses/by-nc-sa/4.0/).
# Flanders Marine Institute (2018). Maritime Boundaries Geodatabase: Maritime Boundaries and Exclusive Economic Zones (200NM), version 10. Available online at http://www.marineregions.org/. https://doi.org/10.14284/312

#### Using the SAU shapefile that contains EEZ per ocean (E.G. Mexico Pacific and Mexico Atlantic)
###________________________________________________________________________________#

# The path
path_world <- "/Volumes/DATA/JULIANO_NEYMAR/FishForVisa/Spatial_Data/SAU_Shapefile/"
#The File
fnam_world <- "SAUEEZ_July2015.shp"
#Load it!

World_EEZs <- readOGR(dsn = path_world,
                      layer =file_path_sans_ext(fnam_world))

# World_EEZs_sf <- st_read(dsn = path_world,
#                       layer = file_path_sans_ext(fnam_world))

# head(World_EEZs)

#### Grid cell information ####

# List of DBEM INDEX within the EEZ
#Data provided by Vicki Lam

EEZIDs_List <- read_excel("~/Documents/UBC/Oceans_Project/Distribution/By Cell/Cell_Data/Updated_EEZList_17June2016.xlsx")
EEZ_CellID <- read_excel("~/Documents/UBC/Oceans_Project/Distribution/By Cell/Cell_Data/EEZ_CellID.xlsx")

colnames(EEZ_CellID) <- c("EEZID","INDEX")

# DBEM Coordinate system
Coor <- fread("~/Documents/UBC/Oceans_Project/Distribution/DBEM/Data/Lon_Lat_DBEM.txt",header = FALSE)
colnames(Coor) <- c("INDEX","Longitude","Latitude")


#### Estimate the number of grid-cells that each EEZ as

EEZ_Size <- EEZ_CellID %>% 
  group_by(EEZID) %>% 
  summarise(n_tot_grid = n()) %>% 
  left_join(EEZIDs_List,
            by = "EEZID")

```

## Functions

### Function `EstNeighbors`

This function determines what EEZs are neighbors and returns a data.frame of it

```{r funEstNeighbors, eval = T, echo=T}
# Determine which countries are neighbors

# Method adopted from Adrew Heiss
# https://gist.github.com/andrewheiss/926b9d60a26e29f6bf32

EstNeighbors <- function(Shapefile){
  
  # Get the list using the poly2nb function
  Neighbor_List <- poly2nb(Shapefile)
  
  # Convert te nb data to a Matrix of crossing references
  Neighbor_Matrix <- nb2mat(Neighbor_List,
                            style="B", 
                            zero.policy=TRUE)
  
  # Rename the matrix axis
  colnames(Neighbor_Matrix) <- rownames(Neighbor_Matrix)
  
  
  # Get the names of the countries for identifying them
  Country_Names <- data_frame(id = row.names(Shapefile@data),
                              Country_Territory = as.character(Shapefile@data$Name),
                              Neighbor_Territory = Country_Territory,
                              EEZID = Shapefile@data$EEZID
                              )
  
  # Clean up and transform the neighbor matrix
  Neighbors <- as.data.frame(Neighbor_Matrix) %>%
    mutate(country = row.names(.)) %>%  # Convert row names to actual column
    gather(neighbor, present, -country) %>%  # Convert to long
    filter(present == 1) %>%  # Only look at cells with a match
    # Add country names
    left_join(select(Country_Names,
                     -Neighbor_Territory), by=c("country" = "id")) %>%
    left_join(select(Country_Names, 
                     -Country_Territory), by=c("neighbor" = "id")) %>% 
    select(EEZID = EEZID.x,Country_Territory,Neighbor_Territory) # select final column
 
  
    # Merge them with SAU data
  
  DBEM_Neighbors_Data <- EEZIDs_List %>% 
  left_join(EEZ_CellID, 
            by = "EEZID") %>% # Asign EEZ id to each country
  left_join(Neighbors, 
            by = "EEZID") %>% # Include all neighboring countries 
  filter(Neighbor_Territory != "NA") %>% 
  left_join(Coor,
            by = "INDEX") # Inclu
  
  return(DBEM_Neighbors_Data)
   
}


### Test function

# Subset data for testing function
# SAU_Regions <- as.data.frame(unique(World_EEZs$Name))

# Test_Countries <-c("Mexico (Atlantic)","Mexico (Pacific)","Guatemala (Caribbean)","Guatemala (Pacific)","Belize")
# Test <- World_EEZs[World_EEZs@data$Name %in% Test_Countries, ]

# Running function
# getNeighbors(Test)

#### Works beautifully! 

```

### Function `GetSppDist`

This function Read in species distribution from the observation data, ESM models and SAU data, still missing DBEM

```{r GetSppDist, eval = T, echo = T}

### Notes
# Function originally created by William (#WC)
# Juliano modifications (#JC)
# This funtion is used in estAbdBinTemp.R
# We are using only summer distribution

### Variables used
# spplisttemp <- Species list template. Information of the species used in the DBEM under TaxaDataC. 
# Distpath <- Path to where the initial distribution of the species is. AKA. Files that start with "S"

#### The function

GetSppDist=function(Spp,Model){
  
  Distpath <- "/Volumes/DATA/JULIANO_NEYMAR/FishForVisa/Distribution_Data/"
  INDEX <- seq(1,259200,1)
  
  # SAU Distributions
  if(Model == "SAU_D"){
    File_Name <- paste("SAU_Distribution/DIST_GOOD_SP_")
  }
  
  # SAU Catch
  if(Model == "SAU_C"){
    File_Name <- paste("SAU_data_per_species/CATCH_SP_")
  }
  
  # Occurence
  if(Model == "Occurence"){
    File_Name <- paste("Occurence/OCCURENCE_JULIANO_")
  }
  
  # ENM Model
  if(Model == "ENM"){
    File_Name <- paste("ENM/ENM_JULIANO_")
  }
  
  # DBEM Data
  # if(Model == "DBEM"){
  #   Distpath <- "/Volumes/DATA/JULIANO_NEYMAR/PristineSeasData
  #   Final_Path <- "ENM"
  #   File_Name <- paste("ENM_JULIANO",Spp,".mat",sep="")
  # }
  
  if(Model == "All"){
    
    Models_List <- c(paste(Distpath,"SAU_Distribution/DIST_GOOD_SP_",Spp,".mat",sep =""),
                     paste(Distpath,"Occurence/OCCURENCE_JULIANO_",Spp,".mat",sep=""),
                     paste(Distpath,"ENM/ENM_JULIANO_",Spp,".mat",sep="")
                     )
    
    # Jumps species not modeled. NOTE: We only need one as ENM, Occ and SAU Dis have all the same 939 spp
    if(file.exists(Models_List[1])){
    
    Load <- lapply(Models_List, FUN=R.matlab::readMat, na.strings=0)
     
    sppdist <- as.data.frame(bind_cols(Load)) %>% 
      mutate(
        INDEX = INDEX,
        TaxonKey = Spp
      )
    colnames(sppdist) <- c("SAU_D","Occ","ENM","INDEX","TaxonKey")
    
    #### Step for SAU catch data that has to be averaged
    File_Name <- paste("SAU_data_per_species/CATCH_SP_")
    SppPath <- paste(Distpath,File_Name,Spp,".mat",sep="")
    
    # For now we're using only the last 10 years average, basicaaly if the species has been fished in any of these years, its considered present
    SAU_C_data <- as.data.frame(R.matlab::readMat(SppPath)) %>% 
      select(CATCH.56:CATCH.65) %>% 
      mutate(INDEX = INDEX) %>% 
      gather("Year","Catch",1:10) %>% # Last 10 years of data
      group_by(INDEX) %>% 
      summarise(SAU_C = mean(Catch,na.rm=T))
    
    # Join both tables
    sppdist <- sppdist %>% 
      left_join(SAU_C_data,
                by = "INDEX") %>% 
      select(TaxonKey,INDEX,everything())
    
    getSppDist = sppdist
    
    }else{
      
      # print(paste("No info for this species"))
    }
    
  }else{  
    
    # Merge paths
    SppPath <- paste(Distpath,File_Name,Spp,".mat",sep="")
    
    if(file.exists(SppPath) == TRUE){
      
    #Install (if needed) R.matlab package
    if(!require(R.matlab)){
      install.packages("R.matlab")
    }
    
    # Read Files
    
    sppdist <- as.data.frame(R.matlab::readMat(SppPath))
    colnames(sppdist) <- Model
    
    # Return 
    getSppDist=sppdist
    
    }else{
    print(paste("No info for this species",Spp, "in",Model))
  }
  
  }
}

#______ Test ______#

# Variables outside function
# head(GetSppDist(600004,"SAU_D")) # Works
# head(GetSppDist(600004,"SAU_C")) # Works
# head(GetSppDist(600004,"Occurence")) # Works
# head(GetSppDist(600004,"ENM")) # Works
# head(GetSppDist(600004,"All")) # Works


```

### Function `EstTransIndex`

```{r Trans_Spp_Function, eval= T ,echo = T,warning = F,message = F}

# Function to determine whether or not a species is transboundary

# Varibales needed
# Spp: Species to be analized, data with presence/absence per gridcell
# Index_EEZ: Reference list of all INDEX that fall within EEZs
# EEZ_Size: Number of grid-cells that each EEZ has
# Neighbors: Reference list of neighbouring countries

# Needs getSppDist

# The function
EstTransIndex <- function(Spp,Model,EEZ_Size,Neighbors){
  
  # Get model data from spps
  SppDist <- GetSppDist(600004,"All")
  
  
  Index_EEZ <- Neighbors %>% 
    select(INDEX)
      # Result 1. Number of Countries that share the species
  # Trans_Index
  
  Trans_Spp <- suppressWarnings(SppDist %>%
    gather("Model","Value",3:6) %>%
    filter(
      INDEX %in% Index_EEZ$INDEX,
      Value != 0
      ) %>%
    left_join(Neighbors,
              by = "INDEX") %>% # Match the species distribution to the Countries EEZs
    group_by(Name = Country_Territory,
             Neighbor_Territory,
             TaxonKey,
             Model
             ) %>% 
    summarise(n_cells_spp = n()) %>% # The number of cells present within each country's EEZ
    left_join(EEZ_Size,
              by = "Name") %>% 
    mutate(Trans_Index = n_cells_spp/n_tot_grid) %>%  # Include one transboundary species
    select(EEZID,everything())
    ) # For the sake of my brain
    
  EstTransIndex=Trans_Spp # A dataframe with each country and neighbouring states sharing the species
  
} # End function


### Testing Function ####
# Spp <- 600006
# Model <- "All"
# EEZ_Size <- EEZ_Size
# Neighbors <- Neighbor_List



```

## Routine

```{r Control_Pannel, eval = T, echo = F}

# Removes everything before the number
Step_One <- gsub(".*_","",list.files("/Volumes/DATA/JULIANO_NEYMAR/FishForVisa/Distribution_Data/SAU_Distribution/"))

# Species List
Species_List <- gsub("\\..*","",Step_One)

# Set Spceies list
Exploited_Species <- fread("/Volumes/DATA/PROJECTION exploited species ENM/exploited_species_list.csv") %>% 
  filter(TaxonKey %in% Species_List)

# For Function
Exploited_Species_List <- Exploited_Species$TaxonKey


####_________________________________________ TESTING PERIOD_________________________________________####
# I'm substetting central america to do the whole analysis (smaller EEZs = faster computation) once I have figure out things I'll run for all

### Data 
# For now using only the subdata 

## Spatial Test Data
# SAU_Regions <- as.data.frame(unique(World_EEZs$Name))

Test_Countries <-c("Guatemala (Caribbean)","Guatemala (Pacific)","Belize","Honduras","El Salvador","Costa Rica (Pacific)","Costa Rica (Caribbean)", "Panama (Caribbean)", "Panama (Pacific)")

Test <- World_EEZs[World_EEZs@data$Name %in% Test_Countries, ]

## Species Test Data Just to know what's captured in these countries 
# 
# SAU_Data <- fread("/Volumes/DATA/JULIANO_NEYMAR/FishForVisa/Distribution_Data/SAU_Catch_Data_Test/SAU_Catch_Data_Test.csv")
# # 
# # #### Species per country
# # 
# Spps <- SAU_Data %>%
#   filter(data_layer == "Reconstructed domestic catch") %>%
#   group_by(area_name,TaxonName = scientific_name) %>%
#   summarise(n()) %>%
#   left_join(Exploited_Species,
#             by = "TaxonName") %>% 
#   filter(TaxonKey %in% Exploited_Species_List$TaxonKey)
# 
# Exploited_Species_List <- Spps$TaxonKey

# Exploited_Species <- c("600004","600006",600107)
# Exploited_Species = 600004
# TaxonKey <- unique(Spps$TaxonKey)

```


```{r Routine, eval = F, echo = F}

# Step 1; EstNeighbordList 
Neighbor_List <- EstNeighbors(Test)
# Neighbor_List <- EstNeighbors(World_EEZs)
# head(Neighbor_List)

# Step 2; EstTransIndex 
system.time(
  Spp_Trans <- bind_rows(
    lapply(
      Exploited_Species_List, FUN=EstTransIndex, EEZ_Size = EEZ_Size, Model = "All", Neighbors = Neighbor_List
    )
  )
)

```

```{r Routine_parallel, eval = T, echo = F}

# Step 1; EstNeighbordList 
Neighbor_List <- EstNeighbors(Test)
# Neighbor_List <- EstNeighbors(World_EEZs)
# head(Neighbor_List)

# Check number of cores
n_Cores <- detectCores()
n_Cores

Spp_Trans <- NULL

system.time(
  Spp_Trans <- bind_rows(
    mclapply(
      Exploited_Species_List, FUN=EstTransIndex, EEZ_Size = EEZ_Size, Model = "All", Neighbors = Neighbor_List, mc.cores = n_Cores
    )
  )
)


### Save Test 

# write.csv(Spp_Trans,
#           "central_america_trans.csv",
#           row.names = F)
# 
```



# Results


```{r, Trans_Results, eval = F, echo = F}

# Result 1. Number of tran spp per EEZ

Spp_Trans %>% 
  group_by(Name,TaxonKey) %>% 
  summarise(Mean_Index = mean(Trans_Index)) %>%  # The higher the less uncertain
  mutate(Uncert = ifelse(Mean_Index >= 0.50 ,"50 %",
                         ifelse(Mean_Index >= 0.25 ,"25 %",
                                ifelse(Mean_Index >= 0.10,">10 %","No Trans")))
         ) %>% 
  group_by(Name,Uncert) %>%
    summarise(nspp=n()) %>%
  ggplot(.,
         aes(
           x = Name,
           y = nspp#,
           # fill = Model
         )
         )+
  geom_bar(stat ="identity") +
  facet_wrap(~Uncert)



# Result 2. List of Countries that share the Species ####
  
Spp_Trans %>% 
  group_by(Name,TaxonKey,Neighbor_Territory) %>% 
  summarise(Mean_Index = mean(Trans_Index)) %>%  # The higher the less uncertain
  mutate(Uncert = ifelse(Mean_Index >= 0.10 & Mean_Index <= 0.25,"10 %",
                         ifelse(Mean_Index >= 0.25 & Mean_Index <= 0.50,"25 %",
                                ifelse(Mean_Index >= 0.50,">50 %","No Trans")))
         ) %>% 
    group_by(Name,Neighbor_Territory,Uncert) %>% 
    summarise(nspp=n())

```

```{r World_Trans_Spp, eval = F,echo = T,warning = F,message = F}

World_Trans_Spp <- function(Species_List,Data_Path,Result){
  
  # Repeat for each species
  for (s in 1:nrow(Species_List)){ # Original code
    
    # Load species distribution data
    Species_Distribution_Path <- paste(Data_Path,Species_List[s,2],".csv",sep="")
    
    # Reads file
    Species_Distribution_Data <- read.csv(Species_Distribution_Path)
    
    # Pastes species name
    Species_Name = Species_List[s,1]
    
    # Call function to determine transboundary species
    Partial <- Trans_Spp_Fun(Species_Distribution_Data,
                             DBEM_Neighbors_Data,
                             Neighbors) %>% 
      mutate(Species = ifelse(Trans > 0,paste(Species_Name),NA)) # Include species name
    
    ### Result 1. Numnber of transboundary species by Country ####
    if(s == 1){
      Trans_Country = Partial
    }else{
      Trans_Country[,3] <- Trans_Country[,3] + Partial [,3] # Sum transboundary species
      Trans_Country[,4] <- Trans_Country[,4] + Partial [,4] # Sum Indexes within eez with TS
      Trans_Country[,5] <- ifelse(Trans_Country[,4] >= 0, paste(Trans_Country[,5],Partial[,5], sep=";"),Trans_Country[,5]) # Paste the species that are transboundary
    }
    
    # Result 2. Number of Countries per Transboundary Species ####
    
    Countries_with_Specie <- Partial %>% 
      filter(Trans == 1) %>% 
      group_by(Neighbor_Territory) %>% 
      summarise() %>% 
      summarise(Number_EEZ = n(),
                Countries = paste(Neighbor_Territory,
                                  collapse = ";")
      ) %>% # Number of territories in this species
      mutate(Species = Species_Name)
    
    
    if(s == 1){
      All_Countries_with_Specie <- Countries_with_Specie
    }else{
      All_Countries_with_Specie <- All_Countries_with_Specie %>% 
        bind_rows(Countries_with_Specie)
    }
    
  }# Closes species list
  
  # Function return
  if(Result =="Country"){ # returns results based on countries 
    return(Trans_Country)
  }
  if(Result == "Species"){ # returns results based on species 
    return(All_Countries_with_Specie)
  }
}

### Testing Function ####
# (Works!!!!!!!!)

### Dummy data ###
# SppA <- Julianus_Coor %>% 
#   filter(V1 >= 100000)
# 
# SppB <- Julianus_Coor %>% 
#   filter(V1 <= 100000)

# write.csv(SppB,
#           "456.csv",
#           row.names = F)

Dummy_Species <- data.frame(
  Species = c("SpeciesA","SpeciesB"),
  TaxonKey = c(123,456)
  )

D_Path <- "./Data/"

Function_Test <- World_Trans_Spp(Dummy_Species,D_Path, Result = "Country")

```

```{r Final_Analysis, eval = F, echo=F}

# Varibales needed
# Species_List
# Data_Path

# Data_Path <- Drobo... Gabs... Distributions...
# DBEM_Species <- Selected_Species
  
  
# World_Trans_Spp(DBEM_Species,Data_Path)


```